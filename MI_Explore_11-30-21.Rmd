---
title: "Michigan Explore"
author: "Blain Morin"
date: "11/24/2021"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(readr)

```

```{r}

### Treatment Data
treatments = read_csv("treatments.csv")


### Assemble 2016 - 2020 data
arr16 = readRDS("~/michigan_arrests/data/ucr_arrests_monthly_all_crimes_race_sex_2016.rds")
arr16 = arr16 %>%
  filter(state_abb == "MI") %>%
  select(fips_county_code, state, agency_name, year, month, starts_with("dui"))


arr17 = readRDS("~/michigan_arrests/data/ucr_arrests_monthly_all_crimes_race_sex_2017.rds")
arr17 = arr17 %>%
  filter(state_abb == "MI") %>%
  select(fips_county_code, state, agency_name, year, month, starts_with("dui"))


arrest = rbind(arr16, arr17)


arr18 = readRDS("~/michigan_arrests/data/ucr_arrests_monthly_all_crimes_race_sex_2018.rds")
arr18 = arr18 %>%
  filter(state_abb == "MI") %>%
  select(fips_county_code, state, agency_name, year, month, starts_with("dui"))


arrest = rbind(arrest, arr18)


arr19 = readRDS("~/michigan_arrests/data/ucr_arrests_monthly_all_crimes_race_sex_2019.rds")
arr19 = arr19 %>%
  filter(state_abb == "MI") %>%
  select(fips_county_code, state, agency_name, year, month, starts_with("dui"))


arrest = rbind(arrest, arr19)


arr20 = readRDS("~/michigan_arrests/data/ucr_arrests_monthly_all_crimes_race_sex_2020.rds")
arr20 = arr20 %>%
  filter(state_abb == "MI") %>%
  select(fips_county_code, state, agency_name, year, month, starts_with("dui"))



arrest = rbind(arrest, arr20)


### Remove to save RAM
remove(arr16, arr17, arr18, arr19, arr20)


### Create Dates
arrest = arrest %>%
  mutate(monthyear = paste(month, year)) %>%
  mutate(d = my(monthyear))





### Attach swab count to respective county and phase
phase1_treated = treatments %>%
  filter(phase == "one") %>%
  select(fips_county_code, number_of_tests)

phase1_ids = phase1_treated$fips_county_code


phase2_treated = treatments %>%
  filter(phase == "two") %>%
  select(fips_county_code, number_of_tests)

phase2_ids = phase2_treated$fips_county_code

treated_ids = unique(treatments$fips_county_code)


phase1_start = my("november 2017")
phase1_end = my("october 2018") # Using October because phase 1 ended on 11/8
phase2_start = my("october 2019")
phase2_end = my("september 2020")


phase1_interval = interval(start = phase1_start, end = phase1_end)
phase2_interval = interval(start = phase2_start, end = phase2_end)


arrest = arrest %>%
  left_join(phase1_treated) %>% 
  mutate(number_of_tests = replace_na(number_of_tests, 0)) %>%
  rename(phase1_swabs = number_of_tests) %>%
  mutate(phase1_swabs = ifelse(d %within% phase1_interval, phase1_swabs, 0)) %>%
  left_join(phase2_treated) %>% 
  mutate(number_of_tests = replace_na(number_of_tests, 0)) %>%
  rename(phase2_swabs = number_of_tests) %>%
  mutate(phase2_swabs = ifelse(d %within% phase2_interval, phase2_swabs, 0))




```

```{r}

check = arrest %>%
  group_by(fips_county_code, phase1_swabs) %>%
  mutate(phase1_dui = sum(dui_tot_arrests)) %>%
  mutate(phase1_dui_white = sum(dui_tot_white)) %>%
  ungroup() %>%
  group_by(fips_county_code, phase2_swabs) %>%
  mutate(phase2_dui = sum(dui_tot_arrests)) %>%
  mutate(phase2_dui_white = sum(dui_tot_white)) %>%
  ungroup()



```






